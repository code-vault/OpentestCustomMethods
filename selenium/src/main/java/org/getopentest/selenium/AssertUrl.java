package org.getopentest.selenium;

import java.util.regex.Pattern;
import org.getopentest.selenium.core.CustomConditions;
import org.getopentest.selenium.core.SeleniumTestAction;
import org.openqa.selenium.support.ui.WebDriverWait;

public class AssertUrl extends SeleniumTestAction {

    @Override
    public void run() {

        super.run();

        String urlIs = this.readStringArgument("urlIs", null);
        String urlContains = this.readStringArgument("urlContains", null);
        Pattern urlMatches = this.readRegexArgument("urlMatches", null);
        boolean caseInsensitive = this.readBooleanArgument("caseInsensitive", false);

        this.waitForAsyncCallsToFinish();

        Pattern regexPattern = null;

        if (urlIs != null) {
            regexPattern = Pattern.compile("^" + Pattern.quote(urlIs) + "$");
        } else if (urlContains != null) {
            regexPattern = Pattern.compile("^.*" + Pattern.quote(urlContains) + ".*$");
        } else if (urlMatches != null) {
            regexPattern = urlMatches;
        } else {
            throw new RuntimeException(
                    "You must indicate the way you want to validate the URL by providing exactly "
                    + "one of the following arguments: urlIs, urlContains or urlMatches.");
        }

        if (caseInsensitive) {
            regexPattern = Pattern.compile(regexPattern.pattern(), regexPattern.flags() & Pattern.CASE_INSENSITIVE);
        }

        try {
            WebDriverWait wait = new WebDriverWait(this.driver, this.getExplicitWaitSec());
            wait.until(CustomConditions.urlToMatch(regexPattern));
        } catch (Exception ex) {
            throw new RuntimeException(String.format(
                    "Failed to validate the current page URL. At the time of this error, the URL was %s",
                    driver.getCurrentUrl()), ex);
        }
    }
}
