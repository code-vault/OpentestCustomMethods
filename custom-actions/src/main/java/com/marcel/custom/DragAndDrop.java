package com.marcel.custom;

import io.appium.java_client.MobileElement;
import io.appium.java_client.touch.offset.PointOption;
import org.getopentest.annotations.TestActionArgument;
import org.getopentest.annotations.TestActionClass;
import org.getopentest.annotations.Type;
import org.getopentest.appium.core.AppiumTestAction;
import org.openqa.selenium.By;
import org.openqa.selenium.Dimension;
import org.openqa.selenium.Point;

@TestActionClass(
        description = "Performs a Drag and Drop action on an element or at the specified coordinates.")
@TestActionArgument(
        name = "locator", type = Type.OBJECT, optional = true,
        description = "Locator object that identifies the element to perform drag and drop.")
@TestActionArgument(
        name = "xStart", type = Type.INTEGER, optional = true,
        description = "Start Y coordinate.")
@TestActionArgument(
        name = "yStart", type = Type.INTEGER, optional = true,
        description = "Start X coordinate.")
@TestActionArgument(
        name = "xEnd", type = Type.INTEGER, optional = true,
        description = "Final X coordinate.")
@TestActionArgument(
        name = "yEnd", type = Type.INTEGER, optional = true,
        description = "Final Y coordinate.")
@TestActionArgument(
        name = "xOffest", type = Type.INTEGER, optional = true,
        description = "Final X coordinate.")
@TestActionArgument(
        name = "yOffset", type = Type.INTEGER, optional = true,
        description = "Final Y coordinate.")


public class DragAndDrop extends AppiumTestAction {

    @Override
    public void run() {
        super.run();

        By locator = this.readLocatorArgument("locator", null);
        Integer xStart = this.readIntArgument("xStart", null);
        Integer yStart = this.readIntArgument("yStart", null);
        Integer xEnd = this.readIntArgument("xEnd", null);
        Integer yEnd = this.readIntArgument("yEnd", null);
        Integer xOffset = this.readIntArgument("xOffset", 0);
        Integer yOffset = this.readIntArgument("yOffset", 0);

        if (locator != null) {
            MobileElement element = this.getElement(locator);
            Point position = element.getLocation();
            Dimension dimension = element.getSize();
            xStart = position.x + (dimension.width / 2) + xOffset;
            yStart = position.y + (dimension.height / 2) + yOffset;
            xEnd = position.x;
            yEnd = yStart;

            AppiumTestAction.getActionsInstance().press(PointOption.point(xStart, yStart)).moveTo(PointOption.point(xEnd, yEnd)).release().perform();
        } else if (xStart != null && yStart != null) {
            AppiumTestAction.getActionsInstance().press(PointOption.point(xStart, yStart)).moveTo(PointOption.point(xEnd, yEnd)).release().perform();
        } else {
            throw new RuntimeException(
                    "You must either provide the locator argument of the element to press, "
                    + "or the x and y arguments to indicate the exact coordinates to press at.");
        }
    }
}
